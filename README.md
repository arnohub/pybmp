# pybmp

pybmp 使用 python2.7 编写的 bmp collector，基于 yabmp 开源项目基础上改造而来，可收集网络设备 BMP 消息，并写入到 mysql 数据库。

报文格式遵循RFC4271和RFC7854 实现initiation_message、peer_down_notification 、peer_up_notification、route_monitoring、statistics_report BMP报文的解析存储。

## initiation_message 

mysql> desc initiation_message;
+-----------------------+------------------+------+-----+---------+----------------+
| Field                 | Type             | Null | Key | Default | Extra          |
+-----------------------+------------------+------+-----+---------+----------------+
| initiation_message_id | int(10) unsigned | NO   | PRI | NULL    | auto_increment |
| device_ip             | text             | YES  |     | NULL    |                |
| sysName               | tinytext         | YES  |     | NULL    |                |
| String                | text             | YES  |     | NULL    |                |
| sysVersion            | text             | YES  |     | NULL    |                |
| sysModel              | text             | YES  |     | NULL    |                |
| timestamp             | datetime         | NO   |     | NULL    |                |
+-----------------------+------------------+------+-----+---------+----------------+

## peer_down_notification

mysql> desc peer_down_notification;
+---------------------------+---------------------+------+-----+---------+----------------+
| Field                     | Type                | Null | Key | Default | Extra          |
+---------------------------+---------------------+------+-----+---------+----------------+
| device_ip                 | varchar(15)         | YES  |     | NULL    |                |
| peer_down_notification_id | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |
| peer_address              | varchar(15)         | YES  |     | NULL    |                |
| peer_bgp_id               | varchar(15)         | YES  |     | NULL    |                |
| peer_as                   | int(10) unsigned    | YES  |     | NULL    |                |
| peer_flags_A              | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_flags_L              | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_flags_V              | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_down_reason          | tinyint(1) unsigned | YES  |     | NULL    |                |
| timestamp                 | datetime            | NO   |     | NULL    |                |
+---------------------------+---------------------+------+-----+---------+----------------+

## peer_up_notification

mysql> desc peer_up_notification;
+----------------------------------+----------------------+------+-----+---------+----------------+
| Field                            | Type                 | Null | Key | Default | Extra          |
+----------------------------------+----------------------+------+-----+---------+----------------+
| peer_up_notification_id          | int(10) unsigned     | NO   | PRI | NULL    | auto_increment |
| device_ip                        | varchar(15)          | YES  |     | NULL    |                |
| peer_address                     | varchar(15)          | YES  |     | NULL    |                |
| peer_bgp_id                      | varchar(15)          | YES  |     | NULL    |                |
| peer_as                          | int(10) unsigned     | YES  |     | NULL    |                |
| peer_flags_A                     | tinyint(1) unsigned  | YES  |     | NULL    |                |
| peer_flags_L                     | tinyint(1) unsigned  | YES  |     | NULL    |                |
| peer_flags_V                     | tinyint(1) unsigned  | YES  |     | NULL    |                |
| peer_hold_time                   | smallint(2) unsigned | YES  |     | NULL    |                |
| peer_bgp_port                    | smallint(2) unsigned | YES  |     | NULL    |                |
| peer_capabilities_route_refresh  | varchar(15)          | YES  |     | NULL    |                |
| peer_capabilities_four_bytes_as  | varchar(15)          | YES  |     | NULL    |                |
| local_address                    | varchar(15)          | YES  |     | NULL    |                |
| local_bgp_id                     | varchar(15)          | YES  |     | NULL    |                |
| local_as                         | int(10) unsigned     | YES  |     | NULL    |                |
| local_hold_time                  | smallint(2) unsigned | YES  |     | NULL    |                |
| local_bgp_port                   | smallint(2) unsigned | YES  |     | NULL    |                |
| local_capabilities_route_refresh | varchar(15)          | YES  |     | NULL    |                |
| local_capabilities_four_bytes_as | varchar(15)          | YES  |     | NULL    |                |
| timestamp                        | datetime             | NO   |     | NULL    |                |
+----------------------------------+----------------------+------+-----+---------+----------------+

## route_monitoring

mysql> desc route_monitoring;
+----------------------------+---------------------+------+-----+---------+----------------+
| Field                      | Type                | Null | Key | Default | Extra          |
+----------------------------+---------------------+------+-----+---------+----------------+
| route_monitoring_id        | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |
| device_ip                  | varchar(15)         | YES  |     | NULL    |                |
| peer_address               | varchar(15)         | YES  |     | NULL    |                |
| peer_bgp_id                | varchar(15)         | YES  |     | NULL    |                |
| peer_as                    | int(10) unsigned    | YES  |     | NULL    |                |
| peer_flags_A               | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_flags_L               | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_flags_V               | tinyint(1) unsigned | YES  |     | NULL    |                |
| path_attr_ORIGIN           | varchar(10)         | YES  |     | NULL    |                |
| path_attr_AS_PATH          | varchar(400)        | YES  |     | NULL    |                |
| path_attr_NEXT_HOP         | varchar(15)         | YES  |     | NULL    |                |
| path_attr_MED              | varchar(10)         | YES  |     | NULL    |                |
| path_attr_LOCAL_PREF       | varchar(10)         | YES  |     | NULL    |                |
| path_attr_ATOMIC_AGGREGATE | varchar(15)         | YES  |     | NULL    |                |
| path_attr_AGGREGATOR       | varchar(40)         | YES  |     | NULL    |                |
| path_attr_COMMUNITY        | varchar(200)        | YES  |     | NULL    |                |
| nlri_withdrawn             | text                | YES  |     | NULL    |                |
| nlri                       | text                | YES  |     | NULL    |                |
| timestamp                  | datetime            | NO   |     | NULL    |                |
+----------------------------+---------------------+------+-----+---------+----------------+

## statistics_report

mysql> desc statistics_report;
+---------------------------------------+---------------------+------+-----+---------+----------------+
| Field                                 | Type                | Null | Key | Default | Extra          |
+---------------------------------------+---------------------+------+-----+---------+----------------+
| statistics_report_id                  | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |
| device_ip                             | varchar(15)         | YES  |     | NULL    |                |
| peer_address                          | varchar(15)         | YES  |     | NULL    |                |
| peer_bgp_id                           | varchar(15)         | YES  |     | NULL    |                |
| peer_as                               | int(10) unsigned    | YES  |     | NULL    |                |
| peer_flags_A                          | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_flags_L                          | tinyint(1) unsigned | YES  |     | NULL    |                |
| peer_flags_V                          | tinyint(1) unsigned | YES  |     | NULL    |                |
| num_pref_rejected_by_in_policy        | varchar(32)         | YES  |     | NULL    |                |
| num_dup_prefixes_advertise            | varchar(10)         | YES  |     | NULL    |                |
| num_dup_withdraws                     | varchar(10)         | YES  |     | NULL    |                |
| num_updates_invalid_CLUSTER_LIST_loop | varchar(10)         | YES  |     | NULL    |                |
| num_updates_invalid_AS_PATH_loop      | varchar(10)         | YES  |     | NULL    |                |
| num_updates_invalid_ORIGINATOR_loop   | varchar(10)         | YES  |     | NULL    |                |
| num_updates_invalid_AS_CONFED_loop    | varchar(10)         | YES  |     | NULL    |                |
| num_routes_Adj_RIBs_In                | varchar(24)         | YES  |     | NULL    |                |
| num_routes_Loc_RIB                    | varchar(24)         | YES  |     | NULL    |                |
| num_routes_per_AFI_SAFI_Adj_RIBs_In   | varchar(24)         | YES  |     | NULL    |                |
| num_routes_per_AFI_SAFI_Loc_RIB       | varchar(24)         | YES  |     | NULL    |                |
| num_updates_treat_as_withdraw         | varchar(10)         | YES  |     | NULL    |                |
| num_prefixes_treat_as_withdraw        | varchar(10)         | YES  |     | NULL    |                |
| num_dup_updates_msg                   | varchar(10)         | YES  |     | NULL    |                |
| timestamp                             | datetime            | NO   |     | NULL    |                |
+---------------------------------------+---------------------+------+-----+---------+----------------+

## 示例

mysql> select * from route_monitoring;
+---------------------+---------------+--------------+----------------+------------+--------------+--------------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+---------------+----------------------+----------------------------+-------------------------------+---------------------+---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
| route_monitoring_id | device_ip     | peer_address | peer_bgp_id    | peer_as    | peer_flags_A | peer_flags_L | peer_flags_V | path_attr_ORIGIN | path_attr_AS_PATH                                                                                                                                                                                                                                                        | path_attr_NEXT_HOP | path_attr_MED | path_attr_LOCAL_PREF | path_attr_ATOMIC_AGGREGATE | path_attr_AGGREGATOR          | path_attr_COMMUNITY | nlri_withdrawn      | nlri                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | timestamp           |
+---------------------+---------------+--------------+----------------+------------+--------------+--------------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+---------------+----------------------+----------------------------+-------------------------------+---------------------+---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
|                   1 | 10.16.0.123   | 10.33.128.1  | 10.33.244.1    | 4200000101 |            0 |            0 |            0 | 2                | [4200000101, 4200000001, 4200000108, 4200002021]                                                                                                                                                                                                                         | 10.33.128.1        | Not exist     | Not exist            | Not exist                  | Not exist                     | Not exist           | []                  | ['10.67.149.0/24']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 2021-03-26 17:38:18 |
+---------------------+---------------+--------------+----------------+------------+--------------+--------------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+---------------+----------------------+----------------------------+-------------------------------+---------------------+---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+

mysql> select * from peer_down_notification;
+---------------+---------------------------+--------------+----------------+---------+--------------+--------------+--------------+------------------+---------------------+
| device_ip     | peer_down_notification_id | peer_address | peer_bgp_id    | peer_as | peer_flags_A | peer_flags_L | peer_flags_V | peer_down_reason | timestamp           |
+---------------+---------------------------+--------------+----------------+---------+--------------+--------------+--------------+------------------+---------------------+
| 10.16.200.196 |                         1 | 172.28.0.50  | 172.28.0.50    |   ***** |            0 |            0 |            0 |                1 | 2021-03-26 18:36:46 |
| 10.16.200.196 |                         2 | 172.28.0.50  | 172.28.0.50    |   ***** |            0 |            0 |            0 |                1 | 2021-03-30 01:29:02 |
+---------------+---------------------------+--------------+----------------+---------+--------------+--------------+--------------+------------------+---------------------+
